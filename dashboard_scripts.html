<script>
// Global state
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let showCompleted = false;
let searchCompany = '';
let filterEmployee = '';
let dateRangeFilter = null; // { start: Date, end: Date }
let dashboardData = null;
let employeeColumnWidth = 100;
let companyColumnWidth = 200;

// Calendar state
let calendarMonth = new Date().getMonth() + 1;
let calendarYear = new Date().getFullYear();
let selectedDateRange = { start: null, end: null };

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadCurrentMonth();
});

function initializeApp() {
  // Month navigation
  document.getElementById('prevMonth').addEventListener('click', () => {
    navigateMonth(-1);
  });
  
  document.getElementById('nextMonth').addEventListener('click', () => {
    navigateMonth(1);
  });
  
  // Search input
  const searchInput = document.getElementById('companySearch');
  searchInput.addEventListener('input', debounce((e) => {
    searchCompany = e.target.value.trim();
    loadData();
  }, 300));
  
  // Date range picker
  initializeDatePicker();
  
  // Employee filter
  document.getElementById('employeeFilter').addEventListener('change', (e) => {
    filterEmployee = e.target.value;
    loadData();
  });
  
  // Completed filter checkbox
  document.getElementById('showCompleted').addEventListener('change', (e) => {
    showCompleted = e.target.checked;
    loadData();
  });
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', () => {
    refreshData();
  });
  
  // Initialize resize functionality
  initializeColumnResize();
  
  updateMonthDisplay();
}

// Date Range Picker
function initializeDatePicker() {
  const dateInput = document.getElementById('dateRangeInput');
  const dropdown = document.getElementById('dateRangeDropdown');
  
  dateInput.addEventListener('click', () => {
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    if (dropdown.style.display === 'block') {
      renderCalendar();
    }
  });
  
  // Calendar navigation
  document.getElementById('prevCalendarMonth').addEventListener('click', () => {
    navigateCalendar(-1);
  });
  
  document.getElementById('nextCalendarMonth').addEventListener('click', () => {
    navigateCalendar(1);
  });
  
  // Actions
  document.getElementById('clearDateRange').addEventListener('click', () => {
    selectedDateRange = { start: null, end: null };
    dateRangeFilter = null;
    dateInput.value = '';
    dropdown.style.display = 'none';
    loadData();
  });
  
  document.getElementById('applyDateRange').addEventListener('click', () => {
    if (selectedDateRange.start) {
      dateRangeFilter = {
        start: selectedDateRange.start,
        end: selectedDateRange.end || selectedDateRange.start
      };
      
      const startStr = formatDate(dateRangeFilter.start);
      const endStr = dateRangeFilter.end && dateRangeFilter.end !== dateRangeFilter.start 
        ? formatDate(dateRangeFilter.end) : '';
      
      dateInput.value = endStr ? `${startStr} - ${endStr}` : startStr;
      dropdown.style.display = 'none';
      loadData();
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.date-picker-container')) {
      dropdown.style.display = 'none';
    }
  });
}

function navigateCalendar(direction) {
  calendarMonth += direction;
  
  if (calendarMonth > 12) {
    calendarMonth = 1;
    calendarYear++;
  } else if (calendarMonth < 1) {
    calendarMonth = 12;
    calendarYear--;
  }
  
  renderCalendar();
}

function renderCalendar() {
  const monthNames = [
    '', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
  ];
  
  document.getElementById('calendarMonthDisplay').textContent = 
    `${monthNames[calendarMonth]} ${calendarYear}`;
  
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';
  
  // Weekday headers
  const weekdays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
  weekdays.forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.textContent = day;
    dayHeader.style.fontWeight = '600';
    dayHeader.style.fontSize = '12px';
    dayHeader.style.color = '#64748b';
    dayHeader.style.textAlign = 'center';
    dayHeader.style.padding = '8px 0';
    grid.appendChild(dayHeader);
  });
  
  // Calendar days
  const firstDay = new Date(calendarYear, calendarMonth - 1, 1);
  const lastDay = new Date(calendarYear, calendarMonth, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  for (let i = 0; i < 42; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.textContent = currentDate.getDate();
    
    if (currentDate.getMonth() !== calendarMonth - 1) {
      dayEl.classList.add('disabled');
    } else {
      dayEl.addEventListener('click', () => selectDate(new Date(currentDate)));
      
      // Check if selected
      if (isDateSelected(currentDate)) {
        dayEl.classList.add('selected');
      }
      
      // Check if in range
      if (isDateInRange(currentDate)) {
        dayEl.classList.add('in-range');
      }
    }
    
    grid.appendChild(dayEl);
  }
}

function selectDate(date) {
  if (!selectedDateRange.start || (selectedDateRange.start && selectedDateRange.end)) {
    // Start new selection
    selectedDateRange = { start: new Date(date), end: null };
  } else {
    // Complete range
    const start = selectedDateRange.start;
    selectedDateRange.end = date < start ? new Date(date) : new Date(date);
    if (date < start) {
      selectedDateRange.start = new Date(date);
      selectedDateRange.end = start;
    }
  }
  
  renderCalendar();
}

function isDateSelected(date) {
  return (selectedDateRange.start && isSameDate(date, selectedDateRange.start)) ||
         (selectedDateRange.end && isSameDate(date, selectedDateRange.end));
}

function isDateInRange(date) {
  if (!selectedDateRange.start || !selectedDateRange.end) return false;
  return date >= selectedDateRange.start && date <= selectedDateRange.end;
}

function isSameDate(date1, date2) {
  return date1.getFullYear() === date2.getFullYear() &&
         date1.getMonth() === date2.getMonth() &&
         date1.getDate() === date2.getDate();
}

function formatDate(date) {
  return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
}

// Debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Column resize functionality
function initializeColumnResize() {
  const employeeHandle = document.getElementById('employeeResizeHandle');
  const companyHandle = document.getElementById('companyResizeHandle');
  
  initializeResize(employeeHandle, 'employee');
  initializeResize(companyHandle, 'company');
  
  updateColumnWidths();
}

function initializeResize(handle, type) {
  let isResizing = false;
  let startX = 0;
  let startWidth = type === 'employee' ? employeeColumnWidth : companyColumnWidth;
  
  handle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = type === 'employee' ? employeeColumnWidth : companyColumnWidth;
    handle.classList.add('resizing');
    document.body.style.cursor = 'col-resize';
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    
    const deltaX = e.clientX - startX;
    const minWidth = type === 'employee' ? 80 : 150;
    const maxWidth = type === 'employee' ? 150 : 350;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    if (type === 'employee') {
      employeeColumnWidth = newWidth;
    } else {
      companyColumnWidth = newWidth;
    }
    
    updateColumnWidths();
  });
  
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      handle.classList.remove('resizing');
      document.body.style.cursor = '';
    }
  });
}

function updateColumnWidths() {
  document.documentElement.style.setProperty('--employee-width', employeeColumnWidth + 'px');
  document.documentElement.style.setProperty('--company-width', companyColumnWidth + 'px');
  
  // Update resize handle positions
  document.getElementById('employeeResizeHandle').style.left = employeeColumnWidth + 'px';
  document.getElementById('companyResizeHandle').style.left = (employeeColumnWidth + companyColumnWidth) + 'px';
}

function navigateMonth(direction) {
  currentMonth += direction;
  
  if (currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  } else if (currentMonth < 1) {
    currentMonth = 12;
    currentYear--;
  }
  
  updateMonthDisplay();
  loadData();
}

function updateMonthDisplay() {
  const monthNames = [
    '', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
  ];
  
  document.getElementById('currentMonthDisplay').textContent = 
    `${monthNames[currentMonth]} ${currentYear}`;
}

function loadCurrentMonth() {
  const now = new Date();
  currentMonth = now.getMonth() + 1;
  currentYear = now.getFullYear();
  calendarMonth = currentMonth;
  calendarYear = currentYear;
  updateMonthDisplay();
  loadData();
}

function loadData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, dateRangeFilter);
}

function refreshData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onRefreshDataLoaded)
    .withFailureHandler(onDataError)
    .refreshCache();
}

function onDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'Có lỗi xảy ra khi tải dữ liệu');
    return;
  }
  
  dashboardData = data;
  
  // Update employee filter options
  updateEmployeeFilter(data.employees || []);
  
  renderDashboard(data);
  showDashboard();
}

function onRefreshDataLoaded(data) {
  // Reset filters after refresh
  searchCompany = '';
  filterEmployee = '';
  dateRangeFilter = null;
  selectedDateRange = { start: null, end: null };
  document.getElementById('companySearch').value = '';
  document.getElementById('employeeFilter').value = '';
  document.getElementById('dateRangeInput').value = '';
  
  onDataLoaded(data);
}

function onDataError(error) {
  hideLoading();
  showError(error.message || 'Không thể tải dữ liệu. Vui lòng thử lại.');
  console.error('Error:', error);
}

function updateEmployeeFilter(employees) {
  const select = document.getElementById('employeeFilter');
  
  // Keep current selection
  const currentValue = select.value;
  
  // Clear existing options except first
  select.innerHTML = '<option value="">Tất cả nhân viên</option>';
  
  // Add employee options
  employees.forEach(employee => {
    const option = document.createElement('option');
    option.value = employee;
    option.textContent = employee;
    select.appendChild(option);
  });
  
  // Restore selection if still valid
  if (currentValue && employees.includes(currentValue)) {
    select.value = currentValue;
  }
}

function renderDashboard(data) {
  renderStats(data.summary);
  renderTimeline(data.timeline);
  updateColumnWidths();
}

// Enhanced stats with number formatting
function renderStats(summary) {
  document.getElementById('completedCompanies').textContent = formatNumber(summary.completedCompanies || 0);
  document.getElementById('pendingCompanies').textContent = formatNumber(summary.pendingCompanies || 0);
  document.getElementById('remainingCompanies').textContent = formatNumber(summary.remainingCompanies || 0);
  document.getElementById('totalPeople').textContent = formatNumber(summary.totalPeople || 0);
  document.getElementById('averagePerDay').textContent = formatNumber(summary.averagePerDay || 0);
}

function formatNumber(num) {
  return new Intl.NumberFormat('vi-VN').format(num);
}

/**
 * Extract first name from full name
 */
function extractFirstName(fullName) {
  if (!fullName) return '';
  const parts = fullName.trim().split(' ');
  return parts[parts.length - 1]; // Last part is usually the first name in Vietnamese
}

/**
 * Enhanced company name shortening
 */
function shortenCompanyName(fullName) {
  const shortcuts = {
    'CÔNG TY CỔ PHẦN': 'CP',
    'CÔNG TY TNHH': 'TNHH',
    'CHI NHÁNH CÔNG TY': 'CN',
    'CÔNG TY CP': 'CP',
    'XUẤT NHẬP KHẨU': 'XNK',
    'THƯƠNG MẠI': 'TM',
    'DỊCH VỤ': 'DV',
    'KINH DOANH': 'KD',
    'PHÁT TRIỂN': 'PT',
    'ĐẦU TƯ': 'ĐT',
    'SẢN XUẤT': 'SX',
    'LOGISTICS': 'LOG',
    'INTERNATIONAL': 'INTL',
    'DEVELOPMENT': 'DEV',
    'TECHNOLOGY': 'TECH',
    'SOLUTIONS': 'SOL',
    'EDUCATION': 'EDU',
    'SOFTWARE': 'SW'
  };
  
  let shortened = fullName;
  
  // Apply shortcuts
  Object.keys(shortcuts).forEach(key => {
    const regex = new RegExp(key, 'gi');
    shortened = shortened.replace(regex, shortcuts[key]);
  });
  
  // Dynamic length based on column width
  const maxLength = Math.floor(companyColumnWidth / 9); // Adjusted character width
  if (shortened.length > maxLength) {
    shortened = shortened.substring(0, maxLength - 3) + '...';
  }
  
  return shortened;
}

function createTooltip(companyName, date, peopleCount) {
  return `${companyName}\nNgày ${date}: ${peopleCount} người khám`;
}

function renderTimeline(timeline) {
  if (!timeline.dates || timeline.dates.length === 0) {
    document.getElementById('timelineBody').innerHTML = 
      '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #64748b;">Không có dữ liệu</td></tr>';
    return;
  }
  
  // Clear existing content
  const weekdayRow = document.getElementById('weekdayRow');
  const dateRow = document.getElementById('dateRow');
  const tbody = document.getElementById('timelineBody');
  
  // Reset headers - keep fixed columns
  weekdayRow.innerHTML = `
    <th class="employee-header"></th>
    <th class="company-header"></th>
    <th class="people-header"></th>
  `;
  dateRow.innerHTML = `
    <th class="employee-header">Nhân viên</th>
    <th class="company-header">Công ty</th>
    <th class="people-header">Người</th>
  `;
  tbody.innerHTML = '';
  
  const today = new Date();
  const isCurrentMonth = (currentMonth === today.getMonth() + 1) && (currentYear === today.getFullYear());
  const todayDate = today.getDate();
  
  // Create weekday and date headers
  timeline.dates.forEach((date, index) => {
    const weekday = timeline.weekdays[index];
    
    // Weekday header
    const weekdayTh = document.createElement('th');
    weekdayTh.textContent = weekday;
    weekdayTh.classList.add('weekday-header');
    
    // Date header
    const dateTh = document.createElement('th');
    dateTh.textContent = date;
    dateTh.classList.add('date-header');
    
    // Mark weekends
    if (weekday === 'CN' || weekday === 'T7') {
      weekdayTh.classList.add('weekend');
      dateTh.classList.add('weekend');
    }
    
    // Mark today
    if (isCurrentMonth && date === todayDate) {
      weekdayTh.classList.add('today');
      dateTh.classList.add('today');
    }
    
    weekdayRow.appendChild(weekdayTh);
    dateRow.appendChild(dateTh);
  });
  
  // Create data rows
  timeline.rows.forEach(row => {
    const tr = document.createElement('tr');
    
    // Handle spacing row
    if (row.isSpacing) {
      tr.classList.add('spacing-row');
      const spacingCell = document.createElement('td');
      spacingCell.colSpan = timeline.dates.length + 3; // +3 for employee, company, people columns
      tr.appendChild(spacingCell);
      tbody.appendChild(tr);
      return;
    }
    
    if (row.company === 'TỔNG') {
      tr.classList.add('total-row');
    }
    
    // Employee name cell
    const employeeCell = document.createElement('td');
    employeeCell.classList.add('employee-cell');
    const employeeName = row.employee ? extractFirstName(row.employee) : '';
    employeeCell.textContent = employeeName;
    employeeCell.title = row.employee || ''; // Full name on hover
    tr.appendChild(employeeCell);
    
    // Company name cell
    const companyCell = document.createElement('td');
    companyCell.classList.add('company-cell');
    const displayName = row.company === 'TỔNG' ? 'TỔNG' : shortenCompanyName(row.company);
    companyCell.textContent = displayName;
    companyCell.title = row.company; // Full name on hover
    tr.appendChild(companyCell);
    
    // People count cell
    const peopleCell = document.createElement('td');
    peopleCell.classList.add('people-cell');
    if (row.total > 0) {
      peopleCell.textContent = formatNumber(row.total);
    } else if (row.total === '') {
      peopleCell.textContent = '';
    } else {
      peopleCell.textContent = '0';
    }
    tr.appendChild(peopleCell);
    
    // Data cells
    row.data.forEach((value, dayIndex) => {
      const td = document.createElement('td');
      td.classList.add('data-cell');
      
      if (value > 0) {
        td.textContent = value;
        td.classList.add('has-data');
        
        // Highlight high volume (>100 people)
        if (value > 100) {
          td.classList.add('high-volume');
        }
        
        // Add tooltip
        const tooltipText = createTooltip(row.company, timeline.dates[dayIndex], value);
        td.title = tooltipText;
        
      } else if (value === '') {
        td.textContent = '';
        // No classes for spacing cells
      } else {
        td.textContent = '';
        td.classList.add('empty');
      }
      
      // Mark weekends
      const weekday = timeline.weekdays[dayIndex];
      if (weekday === 'CN' || weekday === 'T7') {
        td.classList.add('weekend');
      }
      
      // Mark today
      if (isCurrentMonth && timeline.dates[dayIndex] === todayDate) {
        td.classList.add('today');
      }
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

// UI State Management
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
}

function showDashboard() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'r':
        e.preventDefault();
        refreshData();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        navigateMonth(-1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        navigateMonth(1);
        break;
      case 'f':
        e.preventDefault();
        document.getElementById('showCompleted').click();
        break;
      case 'k':
        e.preventDefault();
        document.getElementById('companySearch').focus();
        break;
      case 'd':
        e.preventDefault();
        document.getElementById('dateRangeInput').click();
        break;
    }
  }
});

// Error handling
window.addEventListener('error', (e) => {
  console.error('JavaScript error:', e.error);
  if (document.getElementById('loading').style.display !== 'none') {
    showError('Có lỗi xảy ra. Vui lòng tải lại trang.');
  }
});

// Auto-refresh every 5 minutes
setInterval(() => {
  if (document.getElementById('dashboard').style.display === 'block') {
    loadData();
  }
}, 5 * 60 * 1000);
</script>