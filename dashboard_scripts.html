<script>
// Global state x.
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let showCompleted = false;
let searchCompany = '';
let filterEmployee = '';
let shiftFilter = 'total'; // M·∫∑c ƒë·ªãnh l√† T·ªïng
let timeFilter = 'all'; // M·∫∑c ƒë·ªãnh l√† T·∫•t c·∫£ th·ªùi gian
let dashboardData = null;
let originalData = null; // Keep original unfiltered data
let clinicalData = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadCurrentMonth();
});

function initializeApp() {
  // Month navigation
  document.getElementById('prevMonth').addEventListener('click', () => {
    navigateMonth(-1);
  });
  
  document.getElementById('nextMonth').addEventListener('click', () => {
    navigateMonth(1);
  });
  
  // Search input - only search on Enter
  const searchInput = document.getElementById('companySearch');
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchCompany = e.target.value.trim();
      applyFilters();
    }
  });
  
  // Employee filter - immediate response
  document.getElementById('employeeFilter').addEventListener('change', (e) => {
    filterEmployee = e.target.value;
    applyFilters();
  });
  
  // Shift filter - immediate response v·ªõi server call
  document.getElementById('shiftFilter').addEventListener('change', (e) => {
    shiftFilter = e.target.value;
    console.log('üîß ƒê√£ ch·ªçn shift filter: ' + shiftFilter);
    
    // G·ªçi l·∫°i server v·ªõi shiftFilter m·ªõi
    loadDataWithCurrentFilters();
  });
  
  // Time filter - immediate response v·ªõi server call
  document.getElementById('timeFilter').addEventListener('change', (e) => {
    timeFilter = e.target.value;
    console.log('üîß ƒê√£ ch·ªçn time filter: ' + timeFilter);
    
    // G·ªçi l·∫°i server v·ªõi timeFilter m·ªõi
    loadDataWithCurrentFilters();
  });
  
  // Completed filter checkbox
  document.getElementById('showCompleted').addEventListener('change', (e) => {
    showCompleted = e.target.checked;
    applyFilters();
  });
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', () => {
    refreshData();
  });
  
  updateMonthDisplay();
}

function navigateMonth(direction) {
  currentMonth += direction;
  
  if (currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  } else if (currentMonth < 1) {
    currentMonth = 12;
    currentYear--;
  }
  
  updateMonthDisplay();
  loadData();
}

function updateMonthDisplay() {
  const monthNames = [
    '', 'Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
    'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'
  ];
  
  document.getElementById('currentMonthDisplay').textContent = 
    `${monthNames[currentMonth]} ${currentYear}`;
}

function loadCurrentMonth() {
  const now = new Date();
  currentMonth = now.getMonth() + 1;
  currentYear = now.getFullYear();
  updateMonthDisplay();
  loadData();
}

function loadData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter, timeFilter);
  
  // C≈©ng t·∫£i d·ªØ li·ªáu c·∫≠n l√¢m s√†ng
  loadClinicalData();
}

// Load data v·ªõi current filters
function loadDataWithCurrentFilters() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter, timeFilter);
  
  // C≈©ng t·∫£i d·ªØ li·ªáu c·∫≠n l√¢m s√†ng
  loadClinicalData();
}

function refreshData() {
  showLoading();
  
  // Reset all filters
  searchCompany = '';
  filterEmployee = '';
  showCompleted = false;
  shiftFilter = 'total';
  timeFilter = 'all';
  document.getElementById('companySearch').value = '';
  document.getElementById('employeeFilter').value = '';
  document.getElementById('showCompleted').checked = false;
  document.getElementById('shiftFilter').value = 'total';
  document.getElementById('timeFilter').value = 'all';
  
  google.script.run
    .withSuccessHandler(onRefreshDataLoaded)
    .withFailureHandler(onDataError)
    .refreshCache();
}

function onDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu');
    return;
  }
  
  console.log('üìä Data loaded with shiftFilter:', data.summary?.shiftFilter || 'unknown');
  console.log('üìä Data loaded with timeFilter:', data.summary?.timeFilter || 'all');
  
  originalData = JSON.parse(JSON.stringify(data)); // Deep clone
  dashboardData = data;
  
  // Update employee filter options
  updateEmployeeFilter(data.employees || []);
  
  // Render dashboard tr·ª±c ti·∫øp v·ªõi data ƒë√£ filtered t·ª´ server
  renderDashboard(dashboardData);
  showDashboard();
}

function onRefreshDataLoaded(data) {
  onDataLoaded(data);
}

function onDataError(error) {
  hideLoading();
  showError(error.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
  console.error('Error:', error);
}

function updateEmployeeFilter(employees) {
  const select = document.getElementById('employeeFilter');
  
  // Keep current selection
  const currentValue = select.value;
  
  // Clear existing options except first
  select.innerHTML = '<option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>';
  
  // Add employee options
  employees.forEach(employee => {
    const option = document.createElement('option');
    option.value = employee;
    option.textContent = employee;
    select.appendChild(option);
  });
  
  // Restore selection if still valid
  if (currentValue && employees.includes(currentValue)) {
    select.value = currentValue;
  }
}

// Filter function ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l·∫°i ·ªü cu·ªëi file

function onFilterDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu');
    return;
  }
  
  console.log('üîÑ Filtered data loaded with shiftFilter:', data.summary?.shiftFilter || 'unknown');
  console.log('üîÑ Filtered data loaded with timeFilter:', data.summary?.timeFilter || 'all');
  
  // C·∫≠p nh·∫≠t data hi·ªán t·∫°i
  dashboardData = data;
  
  renderDashboard(dashboardData);
  showDashboard();
}

// Calculate statistics based on actual filtered data from server
function renderStats(summary) {
  // S·ª≠ d·ª•ng data t·ª´ server thay v√¨ t√≠nh to√°n l·∫°i client-side
  document.getElementById('totalCompanies').textContent = formatNumber(summary.totalCompanies || 0);
  document.getElementById('completedCompanies').textContent = formatNumber(summary.completedCompanies || 0);
  document.getElementById('activeCompanies').textContent = formatNumber(summary.activeCompanies || 0);
  document.getElementById('averagePerDay').textContent = formatNumber(summary.averagePerDay || 0);
  
  console.log('üìä Stats rendered:', {
    total: summary.totalCompanies,
    completed: summary.completedCompanies,
    active: summary.activeCompanies,
    avg: summary.averagePerDay,
    filter: summary.shiftFilter,
    timeFilter: summary.timeFilter
  });
}

function formatNumber(num) {
  return new Intl.NumberFormat('vi-VN').format(num);
}

/**
 * Enhanced company name shortening - c·ªë ƒë·ªãnh cho 300px
 */
function shortenCompanyName(fullName) {
  const shortcuts = {
    'C√îNG TY C·ªî PH·∫¶N': 'CP',
    'C√îNG TY TNHH': 'TNHH',
    'CHI NH√ÅNH C√îNG TY': 'CN',
    'C√îNG TY CP': 'CP',
    'XU·∫§T NH·∫¨P KH·∫®U': 'XNK',
    'TH∆Ø∆†NG M·∫†I': 'TM',
    'D·ªäCH V·ª§': 'DV',
    'KINH DOANH': 'KD',
    'PH√ÅT TRI·ªÇN': 'PT',
    'ƒê·∫¶U T∆Ø': 'ƒêT',
    'S·∫¢N XU·∫§T': 'SX',
    'LOGISTICS': 'LOG',
    'INTERNATIONAL': 'INTL',
    'DEVELOPMENT': 'DEV',
    'TECHNOLOGY': 'TECH',
    'SOLUTIONS': 'SOL',
    'EDUCATION': 'EDU',
    'SOFTWARE': 'SW'
  };
  
  let shortened = fullName;
  
  // Apply shortcuts
  Object.keys(shortcuts).forEach(key => {
    const regex = new RegExp(key, 'gi');
    shortened = shortened.replace(regex, shortcuts[key]);
  });
  
  // Fixed max length for 300px column
  const maxLength = 35;
  if (shortened.length > maxLength) {
    shortened = shortened.substring(0, maxLength - 3) + '...';
  }
  
  return shortened;
}

function createTooltip(companyName, date, peopleCount) {
  return `${companyName}\nNg√†y ${date}: ${peopleCount} ng∆∞·ªùi kh√°m`;
}

function renderDashboard(data) {
  renderStats(data.summary);
  renderTimeline(data.timeline);
}

function renderTimeline(timeline) {
  if (!timeline.dates || timeline.dates.length === 0) {
    document.getElementById('timelineBody').innerHTML = 
      '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #64748b;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    return;
  }
  
  // Clear existing content
  const weekdayRow = document.getElementById('weekdayRow');
  const dateRow = document.getElementById('dateRow');
  const tbody = document.getElementById('timelineBody');
  
  // Reset headers - keep fixed columns
  weekdayRow.innerHTML = `
    <th class="company-header"></th>
    <th class="people-header"></th>
  `;
  dateRow.innerHTML = `
    <th class="company-header">C√¥ng ty</th>
    <th class="people-header">Ng∆∞·ªùi</th>
  `;
  tbody.innerHTML = '';
  
  const today = new Date();
  const isCurrentMonth = (currentMonth === today.getMonth() + 1) && (currentYear === today.getFullYear());
  const todayDate = today.getDate();
  
  // Create weekday and date headers
  timeline.dates.forEach((date, index) => {
    const weekday = timeline.weekdays[index];
    
    // Weekday header
    const weekdayTh = document.createElement('th');
    weekdayTh.textContent = weekday;
    weekdayTh.classList.add('weekday-header');
    
    // Date header
    const dateTh = document.createElement('th');
    dateTh.textContent = date;
    dateTh.classList.add('date-header');
    
    // Mark weekends
    if (weekday === 'CN' || weekday === 'T7') {
      weekdayTh.classList.add('weekend');
      dateTh.classList.add('weekend');
    }
    
    // Mark today - only headers
    if (isCurrentMonth && date === todayDate) {
      weekdayTh.classList.add('today');
      dateTh.classList.add('today');
    }
    
    weekdayRow.appendChild(weekdayTh);
    dateRow.appendChild(dateTh);
  });
  
  // S·∫Øp x·∫øp c√°c h√†ng theo s·ªë ng∆∞·ªùi gi·∫£m d·∫ßn
  timeline.rows.sort((a, b) => b.total - a.total);
  
  // Calculate daily totals for the currently displayed companies
  const dailyTotalsFiltered = new Array(timeline.dates.length).fill(0);
  timeline.rows.forEach(row => {
    row.data.forEach((value, index) => {
      dailyTotalsFiltered[index] += value;
    });
  });

  // Add total row first
  const totalTr = document.createElement('tr');
  totalTr.classList.add('total-row', 'clickable');

  const totalCompanyCell = document.createElement('td');
  totalCompanyCell.classList.add('company-cell');
  totalCompanyCell.textContent = 'T·ªîNG';
  
  // Add click event for total details
  totalCompanyCell.addEventListener('click', () => {
    showTotalDetail();
  });
  
  totalTr.appendChild(totalCompanyCell);

  const totalPeopleCell = document.createElement('td');
  totalPeopleCell.classList.add('people-cell');
  const grandTotal = dailyTotalsFiltered.reduce((sum, val) => sum + val, 0);
  totalPeopleCell.textContent = formatNumber(grandTotal);
  totalTr.appendChild(totalPeopleCell);

  dailyTotalsFiltered.forEach((total, dayIndex) => {
    const td = document.createElement('td');
    td.classList.add('data-cell');
    const inner = document.createElement('div');
    inner.classList.add('data-cell-inner');
    inner.textContent = total > 0 ? total : '';
    if (total > 0) {
      td.classList.add('has-data');
      if (total > 100) {
        td.classList.add('high-volume');
      }
      
      // Th√™m s·ª± ki·ªán click cho √¥ d·ªØ li·ªáu trong h√†ng t·ªïng
      td.addEventListener('click', () => {
        showDailyTotalDetail(timeline.dates[dayIndex], dayIndex);
      });
      td.classList.add('clickable');
    } else {
      td.classList.add('empty');
    }
    // Mark weekends for total row
    const weekday = timeline.weekdays[dayIndex];  
    if (weekday === 'CN' || weekday === 'T7') {
      td.classList.add('weekend');
    }
    td.appendChild(inner);
    totalTr.appendChild(td);
  });
  tbody.appendChild(totalTr);
  
  // Create data rows
  timeline.rows.forEach(row => {
    const tr = document.createElement('tr');
    
    // Company name cell
    const companyCell = document.createElement('td');
    companyCell.classList.add('company-cell', 'clickable');
    const displayName = shortenCompanyName(row.company);
    companyCell.textContent = displayName;
    companyCell.title = row.company; // Full name on hover
    
    // Add click event for company details
    companyCell.addEventListener('click', () => {
      showCompanyDetail(row.company);
    });
    
    tr.appendChild(companyCell);
    
    // People count cell - Hi·ªÉn th·ªã t·ªïng s·ªë ng∆∞·ªùi trong c·∫£ giai ƒëo·∫°n
    const peopleCell = document.createElement('td');
    peopleCell.classList.add('people-cell');
    
    // L·∫•y th√¥ng tin chi ti·∫øt c√¥ng ty ƒë·ªÉ t√≠nh t·ªïng s·ªë ng∆∞·ªùi ƒë√∫ng
    let totalPeopleForCompany = 0;
    if (originalData && originalData.companyDetails && originalData.companyDetails[row.company]) {
      const companyDetail = originalData.companyDetails[row.company];
      totalPeopleForCompany = companyDetail.tongNguoi || 0;
    } else {
      // Fallback: s·ª≠ d·ª•ng row.total n·∫øu kh√¥ng c√≥ companyDetails
      totalPeopleForCompany = row.total || 0;
    }
    
    if (totalPeopleForCompany > 0) {
      peopleCell.textContent = formatNumber(totalPeopleForCompany);
    } else {
      peopleCell.textContent = '0';
    }
    tr.appendChild(peopleCell);
    
    // Data cells - Rounded design
    row.data.forEach((value, dayIndex) => {
      const td = document.createElement('td');
      td.classList.add('data-cell');
      
      const inner = document.createElement('div');
      inner.classList.add('data-cell-inner');
      
      if (value > 0) {
        inner.textContent = value;
        td.classList.add('has-data');
        
        // Highlight high volume (>100 people)
        if (value > 100) {
          td.classList.add('high-volume');
        }
        
        // Add tooltip
        const tooltipText = createTooltip(row.company, timeline.dates[dayIndex], value);
        td.title = tooltipText;
        
      } else {
        inner.textContent = '';
        td.classList.add('empty');
      }
      
      // Mark weekends
      const weekday = timeline.weekdays[dayIndex];
      if (weekday === 'CN' || weekday === 'T7') {
        td.classList.add('weekend');
      }
      
      td.appendChild(inner);
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

// H√†m ƒë·ªãnh d·∫°ng ng√†y th√°ng nƒÉm theo mm/dd/yyyy (Google Sheets format)
function formatDate(dateString) {
  if (!dateString) return '';
  
  // Ki·ªÉm tra n·∫øu dateString ƒë√£ l√† ƒë·ªãnh d·∫°ng mm/dd/yyyy
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
    return dateString;
  }
  
  // N·∫øu l√† ƒë·ªãnh d·∫°ng ISO ho·∫∑c kh√°c
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // Tr·∫£ v·ªÅ nguy√™n b·∫£n n·∫øu kh√¥ng ph·∫£i ng√†y h·ª£p l·ªá
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return `${month}/${day}/${year}`;
  } catch (e) {
    console.error('L·ªói ƒë·ªãnh d·∫°ng ng√†y:', e);
    return dateString;
  }
}

// Modal functions
function showCompanyDetail(companyName) {
  if (!originalData || !originalData.companyDetails) {
    console.log('Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt c√¥ng ty');
    return;
  }
  
  const companyDetail = originalData.companyDetails[companyName];
  if (!companyDetail) {
    console.log('Kh√¥ng t√¨m th·∫•y th√¥ng tin chi ti·∫øt cho c√¥ng ty:', companyName);
    return;
  }
  
  const modal = document.getElementById('detailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  // Th√™m th√¥ng tin filter v√†o title
  let titleText = companyName;
  if (shiftFilter === 'sang' || shiftFilter === 'morning') {
    titleText += ' (Ca s√°ng)';
  } else if (shiftFilter === 'chieu' || shiftFilter === 'afternoon') {
    titleText += ' (Ca chi·ªÅu)';
  }
  
  modalTitle.textContent = titleText;
  
  // T√≠nh t·ªïng s·ªë l∆∞·ª£ng kh√°m s√°ng/chi·ªÅu d·ª±a tr√™n shiftFilter hi·ªán t·∫°i
  let displayMorning = 0;
  let displayAfternoon = 0;
  let displayTotal = 0;
  
  // L·∫•y t·ªïng s·ªë ng√†y kh√°m
  const totalDays = companyDetail.tongSoNgay || 0;
  
  if (shiftFilter === 'total') {
    // Hi·ªÉn th·ªã t·ªïng s·ªë l∆∞·ª£ng kh√°m chia ƒë·ªÅu 50/50
    displayTotal = companyDetail.tongNguoi || 0;
    displayMorning = Math.round(displayTotal / 2);
    displayAfternoon = displayTotal - displayMorning; // ƒê·∫£m b·∫£o t·ªïng b·∫±ng displayTotal
  } else if (shiftFilter === 'sang' || shiftFilter === 'morning') {
    // Ch·ªâ hi·ªÉn th·ªã t·ªïng ca s√°ng, ca chi·ªÅu = 0
    displayMorning = (companyDetail.sang || 0) * totalDays;
    displayAfternoon = 0;
    displayTotal = displayMorning;
  } else if (shiftFilter === 'chieu' || shiftFilter === 'afternoon') {
    // Ch·ªâ hi·ªÉn th·ªã t·ªïng ca chi·ªÅu, ca s√°ng = 0
    displayMorning = 0;
    displayAfternoon = (companyDetail.chieu || 0) * totalDays;
    displayTotal = displayAfternoon;
  }
  
  // ƒê·ªãnh d·∫°ng ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c kh√°m
  const startDate = companyDetail.ngayBatDau || '';
  const endDate = companyDetail.ngayKetThuc || '';
  const dateRangeText = startDate && endDate ? `${startDate} - ${endDate}` : 'Ch∆∞a c√≥ th√¥ng tin';
  
  // üîß FIX: Apply formatNumber cho t·∫•t c·∫£ s·ªë li·ªáu
  modalBody.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">S·ªë l∆∞·ª£ng kh√°m s√°ng:</span>
      <span class="detail-value">${formatNumber(displayMorning)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">S·ªë l∆∞·ª£ng kh√°m chi·ªÅu:</span>
      <span class="detail-value">${formatNumber(displayAfternoon)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë ng∆∞·ªùi kh√°m:</span>
      <span class="detail-value">${formatNumber(displayTotal)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë ng√†y kh√°m:</span>
      <span class="detail-value">${formatNumber(companyDetail.tongSoNgay || 0)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Kho·∫£ng th·ªùi gian kh√°m:</span>
      <span class="detail-value">${dateRangeText}</span>
    </div>
    ${companyDetail.employee ? `
    <div class="detail-row">
      <span class="detail-label">Nh√¢n vi√™n ph·ª• tr√°ch:</span>
      <span class="detail-value">${companyDetail.employee}</span>
    </div>
    ` : ''}
  `;
  
  modal.classList.add('show');
}

function showTotalDetail() {
  if (!originalData || !originalData.companyDetails) {
    console.log('Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt');
    return;
  }
  
  // T√≠nh t·ªïng d·ª±a tr√™n companies ƒëang hi·ªÉn th·ªã v√† current shiftFilter
  let totalSang = 0;
  let totalChieu = 0;
  let totalNguoi = 0;
  
  // L·ªçc theo c√¥ng ty ƒëang hi·ªÉn th·ªã trong dashboardData
  if (dashboardData && dashboardData.timeline && dashboardData.timeline.rows) {
    dashboardData.timeline.rows.forEach(row => {
      if (row.company && row.company !== 'T·ªîNG' && !row.isSpacing) {
        const companyDetail = originalData.companyDetails[row.company];
        if (companyDetail) {
          // L·∫•y t·ªïng s·ªë ng√†y kh√°m c·ªßa c√¥ng ty
          const totalDays = companyDetail.tongSoNgay || 0;
          
          // T√≠nh to√°n t·ªïng s·ªë l∆∞·ª£ng kh√°m d·ª±a tr√™n shiftFilter hi·ªán t·∫°i
          if (shiftFilter === 'total') {
            // Ch·ªâ c·ªông d·ªìn t·ªïng s·ªë ng∆∞·ªùi kh√°m, sau ƒë√≥ s·∫Ω chia ƒë·ªÅu ·ªü b√™n d∆∞·ªõi
            totalNguoi += companyDetail.tongNguoi || 0;
          } else if (shiftFilter === 'sang' || shiftFilter === 'morning') {
            totalSang += (companyDetail.sang || 0) * totalDays;
            totalChieu = 0; // Kh√¥ng hi·ªÉn th·ªã ca chi·ªÅu khi filter ca s√°ng
            totalNguoi += (companyDetail.sang || 0) * totalDays;
          } else if (shiftFilter === 'chieu' || shiftFilter === 'afternoon') {
            totalSang = 0; // Kh√¥ng hi·ªÉn th·ªã ca s√°ng khi filter ca chi·ªÅu
            totalChieu += (companyDetail.chieu || 0) * totalDays;
            totalNguoi += (companyDetail.chieu || 0) * totalDays;
          }
        }
      }
    });
  }
  
  // N·∫øu ƒëang xem t·ªïng (kh√¥ng filter), chia ƒë·ªÅu t·ªïng s·ªë ng∆∞·ªùi kh√°m th√†nh hai ph·∫ßn b·∫±ng nhau
  if (shiftFilter === 'total') {
    totalSang = Math.round(totalNguoi / 2);
    totalChieu = totalNguoi - totalSang; // ƒê·∫£m b·∫£o t·ªïng b·∫±ng totalNguoi
  }
  
  const modal = document.getElementById('detailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  // Display title theo current filter
  let titleText = 'T·ªïng h·ª£p t·∫•t c·∫£ c√¥ng ty';
  if (shiftFilter === 'sang' || shiftFilter === 'morning') {
    titleText += ' (Ca s√°ng)';
  } else if (shiftFilter === 'chieu' || shiftFilter === 'afternoon') {
    titleText += ' (Ca chi·ªÅu)';
  }
  
  // Th√™m th√¥ng tin v·ªÅ time filter
  if (timeFilter !== 'all') {
    const timeFilterText = timeFilter === 'today' ? 'H√¥m nay' : 
                          timeFilter === 'week' ? 'Tu·∫ßn n√†y' : 
                          timeFilter === 'month' ? 'Th√°ng n√†y' : '';
    if (timeFilterText) {
      titleText += ` - ${timeFilterText}`;
    }
  }
  
  modalTitle.textContent = titleText;
  
  // üîß FIX: Apply formatNumber cho t·∫•t c·∫£ s·ªë li·ªáu
  modalBody.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë l∆∞·ª£ng kh√°m s√°ng:</span>
      <span class="detail-value">${formatNumber(totalSang)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë l∆∞·ª£ng kh√°m chi·ªÅu:</span>
      <span class="detail-value">${formatNumber(totalChieu)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë ng∆∞·ªùi kh√°m:</span>
      <span class="detail-value">${formatNumber(totalNguoi)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Filter hi·ªán t·∫°i:</span>
      <span class="detail-value">${shiftFilter === 'total' ? 'T·ªïng' : shiftFilter === 'sang' ? 'S√°ng' : 'Chi·ªÅu'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Th·ªùi gian hi·ªán t·∫°i:</span>
      <span class="detail-value">${timeFilter === 'all' ? 'T·∫•t c·∫£' : 
                                  timeFilter === 'today' ? 'H√¥m nay' : 
                                  timeFilter === 'week' ? 'Tu·∫ßn n√†y' : 'Th√°ng n√†y'}</span>
    </div>
  `;
  
  modal.classList.add('show');
}

/**
 * Hi·ªÉn th·ªã chi ti·∫øt cho m·ªôt ng√†y c·ª• th·ªÉ trong h√†ng t·ªïng
 */
function showDailyTotalDetail(day, dayIndex) {
  if (!dashboardData || !dashboardData.timeline || !originalData || !originalData.companyDetails) {
    console.log('Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt ng√†y');
    return;
  }
  
  const timeline = dashboardData.timeline;
  const month = currentMonth;
  const year = currentYear;
  const dateStr = `${day}/${month}/${year}`;
  const weekday = timeline.weekdays[dayIndex];
  
  // T√≠nh t·ªïng s·ªë ng∆∞·ªùi kh√°m trong ng√†y n√†y cho t·∫•t c·∫£ c√¥ng ty ƒëang hi·ªÉn th·ªã
  let totalPeopleToday = 0;
  let companiesWithAppointments = [];
  
  // T√≠nh s·ªë l∆∞·ª£ng kh√°m s√°ng/chi·ªÅu cho ng√†y n√†y d·ª±a tr√™n shiftFilter hi·ªán t·∫°i
  let morningExams = 0;
  let afternoonExams = 0;
  
  // L·ªçc theo c√¥ng ty ƒëang hi·ªÉn th·ªã trong dashboardData
  if (timeline && timeline.rows) {
    timeline.rows.forEach(row => {
      if (row.company && row.company !== 'T·ªîNG' && !row.isSpacing) {
        const peopleCount = row.data[dayIndex] || 0;
        
        if (peopleCount > 0) {
          totalPeopleToday += peopleCount;
          
          // T√≠nh s·ªë l∆∞·ª£ng kh√°m s√°ng/chi·ªÅu d·ª±a tr√™n shiftFilter hi·ªán t·∫°i
          if (shiftFilter === 'total') {
            // Kh√¥ng t√≠nh theo t·ª∑ l·ªá th·ª±c t·∫ø c·ªßa c√¥ng ty n·ªØa m√† chia ƒë·ªÅu 50/50
            // C·ªông d·ªìn s·ªë ng∆∞·ªùi kh√°m, sau ƒë√≥ s·∫Ω chia ƒë·ªÅu ·ªü b√™n d∆∞·ªõi
          } else if (shiftFilter === 'sang' || shiftFilter === 'morning') {
            // N·∫øu ƒëang filter ca s√°ng, t·∫•t c·∫£ s·ªë ng∆∞·ªùi ƒë·ªÅu l√† ca s√°ng
            morningExams += peopleCount;
            afternoonExams = 0;
          } else if (shiftFilter === 'chieu' || shiftFilter === 'afternoon') {
            // N·∫øu ƒëang filter ca chi·ªÅu, t·∫•t c·∫£ s·ªë ng∆∞·ªùi ƒë·ªÅu l√† ca chi·ªÅu
            afternoonExams += peopleCount;
            morningExams = 0;
          }
          
          // Th√™m v√†o danh s√°ch c√¥ng ty c√≥ l·ªãch kh√°m
          companiesWithAppointments.push({
            name: row.company,
            people: peopleCount,
            employee: row.employee || ''
          });
        }
      }
    });
  }
  
  // S·∫Øp x·∫øp c√¥ng ty theo s·ªë ng∆∞·ªùi kh√°m (nhi·ªÅu nh·∫•t l√™n ƒë·∫ßu)
  companiesWithAppointments.sort((a, b) => b.people - a.people);
  
  // N·∫øu ƒëang xem t·ªïng (kh√¥ng filter), chia ƒë·ªÅu t·ªïng s·ªë ng∆∞·ªùi kh√°m th√†nh hai ph·∫ßn b·∫±ng nhau
  if (shiftFilter === 'total') {
    morningExams = Math.round(totalPeopleToday / 2);
    afternoonExams = totalPeopleToday - morningExams; // ƒê·∫£m b·∫£o t·ªïng b·∫±ng totalPeopleToday
  }
  
  const modal = document.getElementById('detailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  // Hi·ªÉn th·ªã ti√™u ƒë·ªÅ v·ªõi th√¥ng tin ng√†y
  modalTitle.textContent = `Chi ti·∫øt ng√†y ${dateStr} (${weekday})`;
  
  // T·∫°o n·ªôi dung chi ti·∫øt
  let detailContent = `
    <div class="detail-row">
      <span class="detail-label">T·ªïng s·ªë ng∆∞·ªùi kh√°m:</span>
      <span class="detail-value">${totalPeopleToday}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">S·ªë l∆∞·ª£ng kh√°m s√°ng:</span>
      <span class="detail-value">${morningExams}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">S·ªë l∆∞·ª£ng kh√°m chi·ªÅu:</span>
      <span class="detail-value">${afternoonExams}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">S·ªë c√¥ng ty c√≥ l·ªãch kh√°m:</span>
      <span class="detail-value">${companiesWithAppointments.length}</span>
    </div>
  `;
  
  // Th√™m danh s√°ch c√¥ng ty c√≥ l·ªãch kh√°m
  if (companiesWithAppointments.length > 0) {
    detailContent += `
      <div class="detail-section">
        <h4 class="detail-section-title">Danh s√°ch c√¥ng ty c√≥ l·ªãch kh√°m:</h4>
        <div class="company-list">
    `;
    
    companiesWithAppointments.forEach(company => {
      detailContent += `
        <div class="company-list-item">
          <span class="company-name">${company.name}</span>
          <span class="company-people">${company.people} ng∆∞·ªùi</span>
          ${company.employee ? `<span class="company-employee">NV: ${company.employee}</span>` : ''}
        </div>
      `;
    });
    
    detailContent += `
        </div>
      </div>
    `;
  }
  
  modalBody.innerHTML = detailContent;
  modal.classList.add('show');
}

function closeDetailModal() {
  const modal = document.getElementById('detailModal');
  modal.classList.remove('show');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
  const modal = document.getElementById('detailModal');
  if (event.target === modal) {
    closeDetailModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeDetailModal();
  }
});

// UI State Management
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
}

function showDashboard() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'r':
        e.preventDefault();
        refreshData();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        navigateMonth(-1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        navigateMonth(1);
        break;
      case 'f':
        e.preventDefault();
        document.getElementById('showCompleted').click();
        break;
      case 'k':
        e.preventDefault();
        document.getElementById('companySearch').focus();
        break;
    }
  }
});

// Error handling
window.addEventListener('error', (e) => {
  console.error('JavaScript error:', e.error);
  if (document.getElementById('loading').style.display !== 'none') {
    showError('C√≥ l·ªói x·∫£y ra. Vui l√≤ng t·∫£i l·∫°i trang.');
  }
});

// Auto-refresh every 5 minutes
setInterval(() => {
  if (document.getElementById('dashboard').style.display === 'block') {
    loadData();
  }
}, 5 * 60 * 1000);

// Clinical Examination Table Functions
function loadClinicalData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onClinicalDataLoaded)
    .withFailureHandler(onDataError)
    .getClinicalData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter, timeFilter);
}

function onClinicalDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu c·∫≠n l√¢m s√†ng');
    return;
  }
  
  // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn global
  clinicalData = data;
  
  renderClinicalTable(data);
}

function renderClinicalTable(clinicalData = null) {
  // N·∫øu kh√¥ng c√≥ data ƒë∆∞·ª£c truy·ªÅn v√†o, load data m·ªõi
  if (!clinicalData) {
    loadClinicalData();
    return;
  }
  
  if (!clinicalData.data || clinicalData.data.length === 0) {
    const clinicalContainer = document.querySelector('.clinical-container');
    if (clinicalContainer) {
      clinicalContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Kh√¥ng c√≥ d·ªØ li·ªáu c·∫≠n l√¢m s√†ng</div>';
    }
    return;
  }
  
  // S·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ server
  const data = clinicalData.data;
  const columns = clinicalData.columns;

  // T√≠nh t·ªïng cho t·ª´ng c·ªôt
  const totals = {};
  columns.forEach(col => {
    totals[col.key] = data.reduce((sum, row) => sum + (row[col.key] || 0), 0);
  });

  // T·∫°o HTML cho b·∫£ng v·ªõi 2 h√†ng header (S√°ng/Chi·ªÅu)
  let tableHTML = `
    <table class="clinical-table" id="clinicalTable">
      <thead>
        <tr class="clinical-header-row clinical-header-main">
          <th class="clinical-header company-header" rowspan="2">Ng√†y</th>
          <th class="clinical-header people-header" rowspan="2">Max</th>
          <th class="clinical-header" colspan="9" style="border-right: 2px solid #2563eb;">S√°ng</th>
          <th class="clinical-header" colspan="9">Chi·ªÅu</th>
        </tr>
        <tr class="clinical-header-row clinical-header-sub">
  `;
  
  // Th√™m header cho c√°c c·ªôt c·∫≠n l√¢m s√†ng theo th·ª© t·ª± ƒë√£ ƒë·ªãnh nghƒ©a
  columns.forEach(col => {
    const shortLabel = col.label.replace(' s√°ng', '').replace(' chi·ªÅu', '');
    tableHTML += `<th class="clinical-header">${shortLabel}</th>`;
  });
  
  tableHTML += `
        </tr>
      </thead>
      <tbody>
  `;
  
  // B·ªè h√†ng t·ªïng v√¨ ƒë√£ chuy·ªÉn sang hi·ªÉn th·ªã theo ng√†y

  // T·∫°o c√°c h√†ng d·ªØ li·ªáu theo ng√†y
  data.forEach(row => {
    const hasData = row.max > 0;
    const today = new Date();
    const currentDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    // Ki·ªÉm tra ng√†y hi·ªán t·∫°i v·ªõi nhi·ªÅu format kh√°c nhau
    const isToday = row.date === currentDate || row.date.startsWith(currentDate) || row.dateKey === currentDate.replace('/', '');
    
    // T√¨m gi√° tr·ªã l·ªõn nh·∫•t cho s√°ng v√† chi·ªÅu
    const morningColumns = columns.filter(col => col.shift === 'morning');
    const afternoonColumns = columns.filter(col => col.shift === 'afternoon');
    
    let maxMorningValue = 0;
    let maxMorningKey = '';
    let maxAfternoonValue = 0;
    let maxAfternoonKey = '';
    
    morningColumns.forEach(col => {
      const value = row[col.key] || 0;
      if (value > maxMorningValue) {
        maxMorningValue = value;
        maxMorningKey = col.key;
      }
    });
    
    afternoonColumns.forEach(col => {
      const value = row[col.key] || 0;
      if (value > maxAfternoonValue) {
        maxAfternoonValue = value;
        maxAfternoonKey = col.key;
      }
    });
    
    tableHTML += `
      <tr class="clinical-row">
        <td class="clinical-data-cell company-cell ${hasData ? 'clickable' : ''} ${isToday ? 'today-highlight' : ''}" ${hasData ? `onclick="showDayDetail('${row.dateKey}', '${row.date}')"` : ''}>
          ${row.date}
        </td>
        <td class="clinical-data-cell people-cell">
          <div class="clinical-data-inner ${hasData ? 'has-data max-value' : 'empty'}">${hasData ? row.max : ''}</div>
        </td>
    `;
    
    columns.forEach(col => {
      const value = row[col.key] || 0;
      let cellClass = '';
      const isMaxValue = (col.key === maxMorningKey && maxMorningValue > 0) || (col.key === maxAfternoonKey && maxAfternoonValue > 0);
      
      if (value > 100) {
        cellClass = 'has-data high-volume';
      } else if (value > 0) {
        cellClass = 'has-data';
      } else {
        cellClass = 'empty';
      }
      
      if (isMaxValue) {
        cellClass += ' max-highlight';
      }
      
      tableHTML += `
        <td class="clinical-data-cell ${cellClass} ${value > 0 ? 'clickable' : ''}" ${value > 0 ? `onclick="showClinicalColumnDetail('${col.key}', '${col.label}')"` : ''}>
          <div class="clinical-data-inner">${value > 0 ? value : ''}</div>
        </td>
      `;
    });
    
    tableHTML += `</tr>`;
  });



  tableHTML += `
      </tbody>
    </table>
  `;

  // C·∫≠p nh·∫≠t DOM
  const clinicalContainer = document.querySelector('.clinical-container');
  if (clinicalContainer) {
    clinicalContainer.innerHTML = tableHTML;
  }
}

// C·∫≠p nh·∫≠t h√†m renderDashboard ƒë·ªÉ bao g·ªìm b·∫£ng c·∫≠n l√¢m s√†ng
const originalRenderDashboard = renderDashboard;
renderDashboard = function(data) {
  // G·ªçi h√†m render dashboard g·ªëc
  originalRenderDashboard(data);
  
  // Render b·∫£ng c·∫≠n l√¢m s√†ng n·∫øu c√≥ d·ªØ li·ªáu
  if (clinicalData && clinicalData.data) {
    renderClinicalTable(clinicalData);
  }
};

// B·ªè h√†m showTotalDetail v√¨ kh√¥ng c√≤n h√†ng t·ªïng

// H√†m hi·ªÉn th·ªã chi ti·∫øt ng√†y khi click v√†o c·ªôt 'Ng√†y'
function showDayDetail(dateKey, dateDisplay) {
  if (!clinicalData || !clinicalData.data) {
    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã');
    return;
  }
  
  // T√¨m d·ªØ li·ªáu c·ªßa ng√†y ƒë∆∞·ª£c click
  const dayData = clinicalData.data.find(row => row.dateKey === dateKey);
  
  if (!dayData) {
    alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ng√†y n√†y');
    return;
  }
  
  // T·∫°o danh s√°ch c√°c h·∫°ng m·ª•c c√≥ d·ªØ li·ªáu
  const categoriesWithData = [];
  clinicalData.columns.forEach(col => {
    const value = dayData[col.key] || 0;
    if (value > 0) {
      categoriesWithData.push({
        label: col.label,
        value: value
      });
    }
  });
  
  if (categoriesWithData.length === 0) {
    alert(`Kh√¥ng c√≥ d·ªØ li·ªáu c·∫≠n l√¢m s√†ng cho ng√†y ${dateDisplay}`);
    return;
  }
  
  // S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
  categoriesWithData.sort((a, b) => b.value - a.value);
  
  let detailHTML = `
    <div class="modal-header">
      <h3>Chi ti·∫øt ng√†y ${dateDisplay}</h3>
      <span class="close" onclick="closeDetailModal()">&times;</span>
    </div>
    <div class="modal-content">
      <div class="detail-summary">
        <p><strong>T·ªïng s·ªë h·∫°ng m·ª•c:</strong> ${categoriesWithData.length}</p>
        <p><strong>T·ªïng s·ªë ng∆∞·ªùi:</strong> ${categoriesWithData.reduce((sum, item) => sum + item.value, 0)}</p>
        <p><strong>S·ªë l∆∞·ª£ng cao nh·∫•t:</strong> ${dayData.max}</p>
      </div>
      <div class="company-list">
  `;
  
  categoriesWithData.forEach(item => {
    detailHTML += `
      <div class="company-item">
        <span class="company-name">${item.label}</span>
        <span class="company-count ${item.value > 100 ? 'high-volume' : 'normal'}">${item.value}</span>
      </div>
    `;
  });
  
  detailHTML += `
      </div>
    </div>
  `;
  
  document.getElementById('modalContent').innerHTML = detailHTML;
  document.getElementById('detailModal').style.display = 'block';
}

// H√†m hi·ªÉn th·ªã chi ti·∫øt c·ªôt c·∫≠n l√¢m s√†ng theo ng√†y
function showClinicalColumnDetail(columnKey, columnLabel) {
  if (!clinicalData || !clinicalData.data) {
    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã');
    return;
  }
  
  // L·ªçc c√°c ng√†y c√≥ d·ªØ li·ªáu cho c·ªôt n√†y
  const daysWithData = clinicalData.data.filter(row => (row[columnKey] || 0) > 0);
  
  if (daysWithData.length === 0) {
    alert(`Kh√¥ng c√≥ ng√†y n√†o c√≥ d·ªØ li·ªáu cho ${columnLabel}`);
    return;
  }
  
  // S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
  daysWithData.sort((a, b) => (b[columnKey] || 0) - (a[columnKey] || 0));
  
  let detailHTML = `
    <div class="modal-header">
      <h3>Chi ti·∫øt ${columnLabel}</h3>
      <span class="close" onclick="closeDetailModal()">&times;</span>
    </div>
    <div class="modal-content">
      <div class="detail-summary">
        <p><strong>T·ªïng s·ªë ng√†y:</strong> ${daysWithData.length}</p>
        <p><strong>T·ªïng s·ªë ng∆∞·ªùi:</strong> ${daysWithData.reduce((sum, row) => sum + (row[columnKey] || 0), 0)}</p>
      </div>
      <div class="company-list">
  `;
  
  daysWithData.forEach(row => {
    const count = row[columnKey] || 0;
    detailHTML += `
      <div class="company-item">
        <span class="company-name">${row.date}</span>
        <span class="company-count ${count > 100 ? 'high-volume' : 'normal'}">${count}</span>
      </div>
    `;
  });
  
  detailHTML += `
      </div>
    </div>
  `;
  
  document.getElementById('modalContent').innerHTML = detailHTML;
  document.getElementById('detailModal').style.display = 'block';
}

// C·∫≠p nh·∫≠t h√†m applyFilters ƒë·ªÉ g·ªçi getClinicalData v·ªõi ƒë√∫ng tham s·ªë
function applyFilters() {
  if (!originalData) return;
  
  // G·ªçi API server ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi v·ªõi t·∫•t c·∫£ filters
  showLoading();
  
  google.script.run
    .withSuccessHandler(onFilterDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter, timeFilter);
  
  // C≈©ng g·ªçi getClinicalData v·ªõi c√πng c√°c tham s·ªë filter
  google.script.run
    .withSuccessHandler(onClinicalDataLoaded)
    .withFailureHandler(onDataError)
    .getClinicalData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter, timeFilter);
}

</script>