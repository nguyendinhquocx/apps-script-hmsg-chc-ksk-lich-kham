<script>
// Global state
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let showCompleted = false;
let dashboardData = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadCurrentMonth();
});

function initializeApp() {
  // Month navigation
  document.getElementById('prevMonth').addEventListener('click', () => {
    navigateMonth(-1);
  });
  
  document.getElementById('nextMonth').addEventListener('click', () => {
    navigateMonth(1);
  });
  
  // Filter checkbox
  document.getElementById('showCompleted').addEventListener('change', (e) => {
    showCompleted = e.target.checked;
    loadData();
  });
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', () => {
    refreshData();
  });
  
  updateMonthDisplay();
}

function navigateMonth(direction) {
  currentMonth += direction;
  
  if (currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  } else if (currentMonth < 1) {
    currentMonth = 12;
    currentYear--;
  }
  
  updateMonthDisplay();
  loadData();
}

function updateMonthDisplay() {
  const monthNames = [
    '', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
  ];
  
  document.getElementById('currentMonthDisplay').textContent = 
    `${monthNames[currentMonth]} ${currentYear}`;
}

function loadCurrentMonth() {
  const now = new Date();
  currentMonth = now.getMonth() + 1;
  currentYear = now.getFullYear();
  updateMonthDisplay();
  loadData();
}

function loadData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted);
}

function refreshData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .refreshCache();
}

function onDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'Có lỗi xảy ra khi tải dữ liệu');
    return;
  }
  
  dashboardData = data;
  renderDashboard(data);
  showDashboard();
}

function onDataError(error) {
  hideLoading();
  showError(error.message || 'Không thể tải dữ liệu. Vui lòng thử lại.');
  console.error('Error:', error);
}

function renderDashboard(data) {
  renderStats(data.summary);
  renderTimeline(data.timeline);
}

function renderStats(summary) {
  document.getElementById('pendingCompanies').textContent = summary.pendingCompanies || 0;
  document.getElementById('completedCompanies').textContent = summary.completedCompanies || 0;
  document.getElementById('averagePerDay').textContent = summary.averagePerDay || 0;
}

/**
 * Rút gọn tên công ty - Improved
 */
function shortenCompanyName(fullName) {
  const shortcuts = {
    'CÔNG TY CỔ PHẦN': 'CP',
    'CÔNG TY TNHH': 'TNHH',
    'CHI NHÁNH CÔNG TY': 'CN',
    'CÔNG TY CP': 'CP',
    'XUẤT NHẬP KHẨU': 'XNK',
    'THƯƠNG MẠI': 'TM',
    'DỊCH VỤ': 'DV',
    'KINH DOANH': 'KD',
    'PHÁT TRIỂN': 'PT',
    'ĐẦU TƯ': 'ĐT',
    'SẢN XUẤT': 'SX',
    'LOGISTICS': 'LOG',
    'INTERNATIONAL': 'INTL',
    'DEVELOPMENT': 'DEV',
    'TECHNOLOGY': 'TECH',
    'SOLUTIONS': 'SOL',
    'EDUCATION': 'EDU',
    'SOFTWARE': 'SW'
  };
  
  let shortened = fullName;
  
  // Apply shortcuts
  Object.keys(shortcuts).forEach(key => {
    const regex = new RegExp(key, 'gi');
    shortened = shortened.replace(regex, shortcuts[key]);
  });
  
  // Limit length
  if (shortened.length > 25) {
    shortened = shortened.substring(0, 22) + '...';
  }
  
  return shortened;
}

/**
 * Create tooltip content
 */
function createTooltip(companyName, date, peopleCount) {
  return `${companyName}\nNgày ${date}: ${peopleCount} người khám`;
}

function renderTimeline(timeline) {
  if (!timeline.dates || timeline.dates.length === 0) {
    document.getElementById('timelineBody').innerHTML = 
      '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #64748b;">Không có dữ liệu</td></tr>';
    return;
  }
  
  // Clear existing content
  const dateRow = document.getElementById('dateRow');
  const tbody = document.getElementById('timelineBody');
  
  dateRow.innerHTML = '<th class="company-header">Công ty</th>';
  tbody.innerHTML = '';
  
  const today = new Date();
  const isCurrentMonth = (currentMonth === today.getMonth() + 1) && (currentYear === today.getFullYear());
  const todayDate = today.getDate();
  
  // Create date headers (no weekdays)
  timeline.dates.forEach((date, index) => {
    const dateTh = document.createElement('th');
    dateTh.textContent = date;
    dateTh.classList.add('date-header');
    
    // Mark weekends
    const fullDate = new Date(currentYear, currentMonth - 1, date);
    const dayOfWeek = fullDate.getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      dateTh.classList.add('weekend');
    }
    
    // Mark today
    if (isCurrentMonth && date === todayDate) {
      dateTh.classList.add('today');
    }
    
    dateRow.appendChild(dateTh);
  });
  
  // Create data rows
  timeline.rows.forEach(row => {
    const tr = document.createElement('tr');
    
    if (row.company === 'TỔNG') {
      tr.classList.add('total-row');
    }
    
    // Company name cell with shortened name
    const companyCell = document.createElement('td');
    companyCell.classList.add('company-cell');
    
    const displayName = row.company === 'TỔNG' ? 'TỔNG' : shortenCompanyName(row.company);
    companyCell.textContent = displayName;
    companyCell.title = row.company; // Full name on hover
    
    tr.appendChild(companyCell);
    
    // Data cells with tooltips
    row.data.forEach((value, dayIndex) => {
      const td = document.createElement('td');
      td.classList.add('data-cell');
      
      if (value > 0) {
        td.textContent = value;
        td.classList.add('has-data');
        
        // Highlight high volume (>10 people)
        if (value > 10) {
          td.classList.add('high-volume');
        }
        
        // Add tooltip
        const tooltipText = createTooltip(row.company, timeline.dates[dayIndex], value);
        td.title = tooltipText;
        
      } else {
        td.textContent = '';
        td.classList.add('empty');
      }
      
      // Mark weekends
      const fullDate = new Date(currentYear, currentMonth - 1, timeline.dates[dayIndex]);
      const dayOfWeek = fullDate.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        td.classList.add('weekend');
      }
      
      // Mark today
      if (isCurrentMonth && timeline.dates[dayIndex] === todayDate) {
        td.classList.add('today');
      }
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

// UI State Management
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
}

function showDashboard() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'r':
        e.preventDefault();
        refreshData();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        navigateMonth(-1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        navigateMonth(1);
        break;
      case 'f':
        e.preventDefault();
        document.getElementById('showCompleted').click();
        break;
    }
  }
});

// Error handling
window.addEventListener('error', (e) => {
  console.error('JavaScript error:', e.error);
  if (document.getElementById('loading').style.display !== 'none') {
    showError('Có lỗi xảy ra. Vui lòng tải lại trang.');
  }
});

// Auto-refresh every 5 minutes
setInterval(() => {
  if (document.getElementById('dashboard').style.display === 'block') {
    loadData();
  }
}, 5 * 60 * 1000);
</script>