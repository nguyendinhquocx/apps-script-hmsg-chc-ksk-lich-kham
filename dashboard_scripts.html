<script>
// Global state
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let showCompleted = false;
let searchCompany = '';
let filterEmployee = '';
let shiftFilter = 'total'; // Mặc định là Tổng
let dashboardData = null;
let originalData = null; // Keep original unfiltered data

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadCurrentMonth();
});

function initializeApp() {
  // Month navigation
  document.getElementById('prevMonth').addEventListener('click', () => {
    navigateMonth(-1);
  });
  
  document.getElementById('nextMonth').addEventListener('click', () => {
    navigateMonth(1);
  });
  
  // Search input - only search on Enter
  const searchInput = document.getElementById('companySearch');
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchCompany = e.target.value.trim();
      applyFilters();
    }
  });
  
  // Employee filter - immediate response
  document.getElementById('employeeFilter').addEventListener('change', (e) => {
    filterEmployee = e.target.value;
    applyFilters();
  });
  
  // Shift filter - immediate response
  document.getElementById('shiftFilter').addEventListener('change', (e) => {
    shiftFilter = e.target.value;
    applyFilters();
  });
  
  // Completed filter checkbox
  document.getElementById('showCompleted').addEventListener('change', (e) => {
    showCompleted = e.target.checked;
    applyFilters();
  });
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', () => {
    refreshData();
  });
  
  updateMonthDisplay();
}

function navigateMonth(direction) {
  currentMonth += direction;
  
  if (currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  } else if (currentMonth < 1) {
    currentMonth = 12;
    currentYear--;
  }
  
  updateMonthDisplay();
  loadData();
}

function updateMonthDisplay() {
  const monthNames = [
    '', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
  ];
  
  document.getElementById('currentMonthDisplay').textContent = 
    `${monthNames[currentMonth]} ${currentYear}`;
}

function loadCurrentMonth() {
  const now = new Date();
  currentMonth = now.getMonth() + 1;
  currentYear = now.getFullYear();
  updateMonthDisplay();
  loadData();
}

function loadData() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(onDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, false, '', '', shiftFilter); // Thêm shiftFilter parameter
}

function refreshData() {
  showLoading();
  
  // Reset all filters
  searchCompany = '';
  filterEmployee = '';
  showCompleted = false;
  shiftFilter = 'total';
  document.getElementById('companySearch').value = '';
  document.getElementById('employeeFilter').value = '';
  document.getElementById('showCompleted').checked = false;
  document.getElementById('shiftFilter').value = 'total';
  
  google.script.run
    .withSuccessHandler(onRefreshDataLoaded)
    .withFailureHandler(onDataError)
    .refreshCache();
}

function onDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'Có lỗi xảy ra khi tải dữ liệu');
    return;
  }
  
  originalData = JSON.parse(JSON.stringify(data)); // Deep clone
  dashboardData = data;
  
  // Update employee filter options
  updateEmployeeFilter(data.employees || []);
  
  // Apply current filters
  applyFilters();
  
  showDashboard();
}

function onRefreshDataLoaded(data) {
  onDataLoaded(data);
}

function onDataError(error) {
  hideLoading();
  showError(error.message || 'Không thể tải dữ liệu. Vui lòng thử lại.');
  console.error('Error:', error);
}

function updateEmployeeFilter(employees) {
  const select = document.getElementById('employeeFilter');
  
  // Keep current selection
  const currentValue = select.value;
  
  // Clear existing options except first
  select.innerHTML = '<option value="">Tất cả nhân viên</option>';
  
  // Add employee options
  employees.forEach(employee => {
    const option = document.createElement('option');
    option.value = employee;
    option.textContent = employee;
    select.appendChild(option);
  });
  
  // Restore selection if still valid
  if (currentValue && employees.includes(currentValue)) {
    select.value = currentValue;
  }
}

// Filter function - Gửi filter đến server
function applyFilters() {
  if (!originalData) return;
  
  // Gọi API server để lấy dữ liệu mới với filter
  showLoading();
  
  google.script.run
    .withSuccessHandler(onFilterDataLoaded)
    .withFailureHandler(onDataError)
    .getScheduleData(currentMonth, currentYear, showCompleted, searchCompany, filterEmployee, shiftFilter);
}

function onFilterDataLoaded(data) {
  hideLoading();
  
  if (!data.success) {
    showError(data.error || 'Có lỗi xảy ra khi tải dữ liệu');
    return;
  }
  
  // Cập nhật data hiện tại (không phải deep clone original)
  dashboardData = data;
  
  renderDashboard(dashboardData);
  showDashboard();
}

// Check if company is completed (all examination dates are in the past)
function isCompanyCompleted(row) {
  const today = new Date();
  const currentDate = today.getDate();
  
  // Check if all examination dates are before today
  let hasExaminations = false;
  let allCompleted = true;
  
  row.data.forEach((value, index) => {
    if (value > 0) {
      hasExaminations = true;
      const examDate = dashboardData.timeline.dates[index];
      if (examDate >= currentDate) {
        allCompleted = false;
      }
    }
  });
  
  return hasExaminations && allCompleted;
}

// Calculate statistics based on filtered data
function calculateStats(rows) {
  const today = new Date();
  const currentDate = today.getDate();
  
  let totalCompanies = 0;
  let completedCompanies = 0;
  let activeCompanies = 0;
  let pendingCompanies = 0;
  let totalPeople = 0;
  
  // Calculate total days in the current month for average calculation
  const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
  
  // Create a map to store daily totals for the filtered data
  const dailyTotalsFiltered = {};

  rows.forEach(row => {
    if (row.isSpacing || row.company === 'TỔNG') return; // Skip spacing and original total row
    
    totalCompanies++;
    
    let hasExaminations = false;
    let hasCompletedExams = false;
    let hasActiveExams = false;
    let companyTotal = 0;
    
    row.data.forEach((value, index) => {
      if (value > 0) {
        hasExaminations = true;
        companyTotal += value;
        
        // Accumulate daily totals for filtered data
        const dayOfMonth = dashboardData.timeline.dates[index]; // Use dates from the original timeline for correct day mapping
        const dateKey = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${dayOfMonth.toString().padStart(2, '0')}`;
        dailyTotalsFiltered[dateKey] = (dailyTotalsFiltered[dateKey] || 0) + value;

        if (dayOfMonth < currentDate) {
          hasCompletedExams = true;
        } else if (dayOfMonth >= currentDate) {
          hasActiveExams = true;
        }
      }
    });
    
    totalPeople += companyTotal;
    
    if (hasExaminations) {
      if (hasCompletedExams && !hasActiveExams) {
        // Company has completed all examinations
        completedCompanies++;
      } else if (hasActiveExams) {
        // Company has ongoing or future examinations
        activeCompanies++;
      }
    }
  });
  
  // Pending companies = Total companies - Completed companies - Active companies
  pendingCompanies = totalCompanies - completedCompanies - activeCompanies;
  
  // Calculate average per day based on filtered daily totals
  const totalPeopleInFilteredDays = Object.values(dailyTotalsFiltered).reduce((sum, val) => sum + val, 0);
  const averagePerDay = daysInMonth > 0 ? Math.round(totalPeopleInFilteredDays / daysInMonth) : 0;
  
  return {
    totalCompanies,
    completedCompanies,
    activeCompanies,
    pendingCompanies,
    totalPeople: totalPeopleInFilteredDays, // Use the sum of filtered daily totals
    averagePerDay
  };
}

function renderDashboard(data) {
  renderStats(data.summary);
  renderTimeline(data.timeline);
}

// Enhanced stats with correct calculations - removed pendingCompanies
function renderStats(summary) {
  document.getElementById('totalCompanies').textContent = formatNumber(summary.totalCompanies || 0);
  document.getElementById('completedCompanies').textContent = formatNumber(summary.completedCompanies || 0);
  document.getElementById('activeCompanies').textContent = formatNumber(summary.activeCompanies || 0);
  document.getElementById('averagePerDay').textContent = formatNumber(summary.averagePerDay || 0);
}

function formatNumber(num) {
  return new Intl.NumberFormat('vi-VN').format(num);
}

/**
 * Enhanced company name shortening - cố định cho 300px
 */
function shortenCompanyName(fullName) {
  const shortcuts = {
    'CÔNG TY CỔ PHẦN': 'CP',
    'CÔNG TY TNHH': 'TNHH',
    'CHI NHÁNH CÔNG TY': 'CN',
    'CÔNG TY CP': 'CP',
    'XUẤT NHẬP KHẨU': 'XNK',
    'THƯƠNG MẠI': 'TM',
    'DỊCH VỤ': 'DV',
    'KINH DOANH': 'KD',
    'PHÁT TRIỂN': 'PT',
    'ĐẦU TƯ': 'ĐT',
    'SẢN XUẤT': 'SX',
    'LOGISTICS': 'LOG',
    'INTERNATIONAL': 'INTL',
    'DEVELOPMENT': 'DEV',
    'TECHNOLOGY': 'TECH',
    'SOLUTIONS': 'SOL',
    'EDUCATION': 'EDU',
    'SOFTWARE': 'SW'
  };
  
  let shortened = fullName;
  
  // Apply shortcuts
  Object.keys(shortcuts).forEach(key => {
    const regex = new RegExp(key, 'gi');
    shortened = shortened.replace(regex, shortcuts[key]);
  });
  
  // Fixed max length for 300px column
  const maxLength = 35;
  if (shortened.length > maxLength) {
    shortened = shortened.substring(0, maxLength - 3) + '...';
  }
  
  return shortened;
}

function createTooltip(companyName, date, peopleCount) {
  return `${companyName}\nNgày ${date}: ${peopleCount} người khám`;
}

function renderTimeline(timeline) {
  if (!timeline.dates || timeline.dates.length === 0) {
    document.getElementById('timelineBody').innerHTML = 
      '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #64748b;">Không có dữ liệu</td></tr>';
    return;
  }
  
  // Clear existing content
  const weekdayRow = document.getElementById('weekdayRow');
  const dateRow = document.getElementById('dateRow');
  const tbody = document.getElementById('timelineBody');
  
  // Reset headers - keep fixed columns
  weekdayRow.innerHTML = `
    <th class="company-header"></th>
    <th class="people-header"></th>
  `;
  dateRow.innerHTML = `
    <th class="company-header">Công ty</th>
    <th class="people-header">Người</th>
  `;
  tbody.innerHTML = '';
  
  const today = new Date();
  const isCurrentMonth = (currentMonth === today.getMonth() + 1) && (currentYear === today.getFullYear());
  const todayDate = today.getDate();
  
  // Create weekday and date headers
  timeline.dates.forEach((date, index) => {
    const weekday = timeline.weekdays[index];
    
    // Weekday header
    const weekdayTh = document.createElement('th');
    weekdayTh.textContent = weekday;
    weekdayTh.classList.add('weekday-header');
    
    // Date header
    const dateTh = document.createElement('th');
    dateTh.textContent = date;
    dateTh.classList.add('date-header');
    
    // Mark weekends
    if (weekday === 'CN' || weekday === 'T7') {
      weekdayTh.classList.add('weekend');
      dateTh.classList.add('weekend');
    }
    
    // Mark today - only headers
    if (isCurrentMonth && date === todayDate) {
      weekdayTh.classList.add('today');
      dateTh.classList.add('today');
    }
    
    weekdayRow.appendChild(weekdayTh);
    dateRow.appendChild(dateTh);
  });
  
  // Create data rows
  timeline.rows.forEach(row => {
    const tr = document.createElement('tr');
    
    // Company name cell
    const companyCell = document.createElement('td');
    companyCell.classList.add('company-cell', 'clickable');
    const displayName = shortenCompanyName(row.company);
    companyCell.textContent = displayName;
    companyCell.title = row.company; // Full name on hover
    
    // Add click event for company details
    companyCell.addEventListener('click', () => {
      showCompanyDetail(row.company);
    });
    
    tr.appendChild(companyCell);
    
    // People count cell
    const peopleCell = document.createElement('td');
    peopleCell.classList.add('people-cell');
    if (row.total > 0) {
      peopleCell.textContent = formatNumber(row.total);
    } else {
      peopleCell.textContent = '0';
    }
    tr.appendChild(peopleCell);
    
    // Data cells - Rounded design
    row.data.forEach((value, dayIndex) => {
      const td = document.createElement('td');
      td.classList.add('data-cell');
      
      const inner = document.createElement('div');
      inner.classList.add('data-cell-inner');
      
      if (value > 0) {
        inner.textContent = value;
        td.classList.add('has-data');
        
        // Highlight high volume (>100 people)
        if (value > 100) {
          td.classList.add('high-volume');
        }
        
        // Add tooltip
        const tooltipText = createTooltip(row.company, timeline.dates[dayIndex], value);
        td.title = tooltipText;
        
      } else {
        inner.textContent = '';
        td.classList.add('empty');
      }
      
      // Mark weekends
      const weekday = timeline.weekdays[dayIndex];
      if (weekday === 'CN' || weekday === 'T7') {
        td.classList.add('weekend');
      }
      
      td.appendChild(inner);
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });

  // Calculate daily totals for the currently displayed companies
  const dailyTotalsFiltered = new Array(timeline.dates.length).fill(0);
  timeline.rows.forEach(row => {
    row.data.forEach((value, index) => {
      dailyTotalsFiltered[index] += value;
    });
  });

  // Add spacing row
  const spacingTr = document.createElement('tr');
  spacingTr.classList.add('spacing-row');
  const spacingCell = document.createElement('td');
  spacingCell.colSpan = timeline.dates.length + 2; // +2 for company, people columns
  spacingTr.appendChild(spacingCell);
  tbody.appendChild(spacingTr);

  // Add total row
  const totalTr = document.createElement('tr');
  totalTr.classList.add('total-row', 'clickable');

  const totalCompanyCell = document.createElement('td');
  totalCompanyCell.classList.add('company-cell');
  totalCompanyCell.textContent = 'TỔNG';
  
  // Add click event for total details
  totalCompanyCell.addEventListener('click', () => {
    showTotalDetail();
  });
  
  totalTr.appendChild(totalCompanyCell);

  const totalPeopleCell = document.createElement('td');
  totalPeopleCell.classList.add('people-cell');
  const grandTotal = dailyTotalsFiltered.reduce((sum, val) => sum + val, 0);
  totalPeopleCell.textContent = formatNumber(grandTotal);
  totalTr.appendChild(totalPeopleCell);

  dailyTotalsFiltered.forEach((total, dayIndex) => {
    const td = document.createElement('td');
    td.classList.add('data-cell');
    const inner = document.createElement('div');
    inner.classList.add('data-cell-inner');
    inner.textContent = total > 0 ? total : '';
    if (total > 0) {
      td.classList.add('has-data');
      if (total > 100) {
        td.classList.add('high-volume');
      }
    } else {
      td.classList.add('empty');
    }
    // Mark weekends for total row
    const weekday = timeline.weekdays[dayIndex];
    if (weekday === 'CN' || weekday === 'T7') {
      td.classList.add('weekend');
    }
    td.appendChild(inner);
    totalTr.appendChild(td);
  });
  tbody.appendChild(totalTr);
}

// Modal functions
function showCompanyDetail(companyName) {
  if (!originalData || !originalData.companyDetails) {
    console.log('Không có dữ liệu chi tiết công ty');
    return;
  }
  
  const companyDetail = originalData.companyDetails[companyName];
  if (!companyDetail) {
    console.log('Không tìm thấy thông tin chi tiết cho công ty:', companyName);
    return;
  }
  
  const modal = document.getElementById('detailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  modalTitle.textContent = companyName;
  
  modalBody.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">Số lượng khám sáng:</span>
      <span class="detail-value">${companyDetail.sang || 0}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Số lượng khám chiều:</span>
      <span class="detail-value">${companyDetail.chieu || 0}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Tổng số người khám:</span>
      <span class="detail-value">${companyDetail.tongNguoi || 0}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Tổng số ngày khám:</span>
      <span class="detail-value">${companyDetail.tongSoNgay || 0}</span>
    </div>
    ${companyDetail.employee ? `
    <div class="detail-row">
      <span class="detail-label">Nhân viên phụ trách:</span>
      <span class="detail-value">${companyDetail.employee}</span>
    </div>
    ` : ''}
  `;
  
  modal.classList.add('show');
}

function showTotalDetail() {
  if (!originalData || !originalData.companyDetails) {
    console.log('Không có dữ liệu chi tiết');
    return;
  }
  
  // Tính tổng sáng/chiều từ tất cả công ty hiện đang hiển thị
  let totalSang = 0;
  let totalChieu = 0;
  let totalNguoi = 0;
  
  // Lọc theo công ty đang hiển thị trong dashboardData
  if (dashboardData && dashboardData.timeline && dashboardData.timeline.rows) {
    dashboardData.timeline.rows.forEach(row => {
      if (row.company && row.company !== 'TỔNG' && !row.isSpacing) {
        const companyDetail = originalData.companyDetails[row.company];
        if (companyDetail) {
          totalSang += companyDetail.sang || 0;
          totalChieu += companyDetail.chieu || 0;
          totalNguoi += companyDetail.tongNguoi || 0;
        }
      }
    });
  }
  
  const modal = document.getElementById('detailModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  
  modalTitle.textContent = 'Tổng hợp tất cả công ty';
  
  modalBody.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">Tổng số lượng khám sáng:</span>
      <span class="detail-value">${totalSang}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Tổng số lượng khám chiều:</span>
      <span class="detail-value">${totalChieu}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Tổng số người khám:</span>
      <span class="detail-value">${totalNguoi}</span>
    </div>
  `;
  
  modal.classList.add('show');
}

function closeDetailModal() {
  const modal = document.getElementById('detailModal');
  modal.classList.remove('show');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
  const modal = document.getElementById('detailModal');
  if (event.target === modal) {
    closeDetailModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeDetailModal();
  }
});

// UI State Management
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
}

function showDashboard() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
}

// Enhanced keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'r':
        e.preventDefault();
        refreshData();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        navigateMonth(-1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        navigateMonth(1);
        break;
      case 'f':
        e.preventDefault();
        document.getElementById('showCompleted').click();
        break;
      case 'k':
        e.preventDefault();
        document.getElementById('companySearch').focus();
        break;
    }
  }
});

// Error handling
window.addEventListener('error', (e) => {
  console.error('JavaScript error:', e.error);
  if (document.getElementById('loading').style.display !== 'none') {
    showError('Có lỗi xảy ra. Vui lòng tải lại trang.');
  }
});

// Auto-refresh every 5 minutes
setInterval(() => {
  if (document.getElementById('dashboard').style.display === 'block') {
    loadData();
  }
}, 5 * 60 * 1000);
</script>